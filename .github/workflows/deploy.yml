# ─────────────────────────────────────
# CD — Docker Build & Push
# ─────────────────────────────────────
# Builds and pushes the Docker image to GitHub Container Registry (ghcr.io).
# Triggers on:
#   - Push to main/master (builds :latest)
#   - Version tags v*.*.* (builds :version)
#   - Manual dispatch

name: CD — Docker Build

on:
    push:
        branches: [main, master]
        tags: ["v*.*.*"]
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # ── Gate: only deploy if tests pass ──
    test:
        name: Run Tests First
        uses: ./.github/workflows/ci.yml

    build-and-push:
        name: Build & Push Docker Image
        runs-on: ubuntu-latest
        needs: test
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels)
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix=

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Image digest
              run: echo "Image pushed with digest ${{ steps.build-push.outputs.digest }}"

    # ── Optional: verify the built image starts correctly ──
    smoke-test:
        name: Smoke Test Container
        runs-on: ubuntu-latest
        needs: build-and-push

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: jobhunter
                    POSTGRES_PASSWORD: jobhunter
                    POSTGRES_DB: jobhunter
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U jobhunter"
                    --health-interval 5s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Pull and run container
              run: |
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
                  docker run -d --name app \
                    --network host \
                    -e JWT_SECRET_KEY=smoke-test-secret \
                    -e LLM_PROVIDER=groq \
                    -e DATABASE_URL=postgresql://jobhunter:jobhunter@localhost:5432/jobhunter \
                    -e API_HOST=0.0.0.0 \
                    -e API_PORT=8000 \
                    ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

            - name: Wait for startup
              run: |
                  echo "Waiting for app to start..."
                  for i in $(seq 1 30); do
                    if curl -sf http://localhost:8000/ > /dev/null 2>&1; then
                      echo "App is healthy!"
                      exit 0
                    fi
                    echo "Attempt $i/30 — waiting..."
                    sleep 2
                  done
                  echo "App failed to start"
                  docker logs app
                  exit 1

            - name: Verify health endpoint
              run: |
                  response=$(curl -sf http://localhost:8000/)
                  echo "Health response: $response"
                  echo "$response" | python3 -c "
                  import sys, json
                  data = json.load(sys.stdin)
                  assert 'message' in data, 'Missing message field'
                  assert 'database' in data, 'Missing database field'
                  print('✅ Health check passed')
                  "

            - name: Cleanup
              if: always()
              run: docker rm -f app 2>/dev/null || true
